---
title: "Exhibit Results"
output: html_document
date: "2022-10-11"
---

```{r child=if(T){"../Child_RMDs/_Set_Up.Rmd"}else{NULL}, eval=TRUE}
```
```{r child=if(params$is_subroutine_lgl){"../Child_RMDs/_Copyright.Rmd"}else{NULL}, eval=TRUE}
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

```{r echo=FALSE, eval=!is.null(params$X)}
paths_ls<- params$X$paths_ls
```

```{r child=if(params$is_subroutine_lgl){"../Child_RMDs/XX_Funs.Rmd"}else{NULL}, eval=TRUE}
```
```{r child=if(T){"../Child_RMDs/_XX_Results_Fns.Rmd"}else{NULL}, eval=TRUE}
```

```{r eval=params$eval_1L_lgl, echo=F}
dce_design_ls <- readRDS(paste0(paths_ls$Replication,"/dce_design_ls.RDS")) # Need to change to get data from online repo
```
```{r eval = params$eval_1L_lgl, echo=F}
preprocessing_log_ls <- readRDS(paste0(paths_ls$Replication,"/preprocessing_log_ls.RDS")) 
records_ls <- readRDS(paste0(paths_ls$Records,"/records_ls.RDS"))
```
```{r eval=params$eval_1L_lgl, echo=F}
descriptives_ls <- readRDS(paste0(paths_ls$Results,"/descriptives_ls.RDS")) 
```
```{r eval=params$eval_1L_lgl, echo=F}
mdl_params_ls <- readRDS(paste0(paths_ls$Replication,"/mdl_params_ls.RDS")) # Need to change to get data from online repo
```
```{r eval=params$eval_1L_lgl, echo=F}
mdls_ls <- readRDS(paste0(paths_ls$Models,"/mdls_ls.RDS"))
```
```{r eval=params$eval_1L_lgl, echo=F}
analysis_ls <- readRDS(paste0(paths_ls$Results,"/analysis_ls.RDS")) 
```

# Data processing
The raw dataset, that included records for each time any participant began viewing the online survey had `r preprocessing_log_ls$raw_case_nbrs_1L_int` records.

```{r include=F}
preprocessing_log_ls$raw_case_nbrs_1L_int
```

When we dropped all records for which there were zero responses to the choice card questions, the number of records was `r preprocessing_log_ls$raw_choice_resps_1L_int`.

```{r include=F}
preprocessing_log_ls$raw_choice_resps_1L_int
```

A total of `r preprocessing_log_ls$flags_freq_df %>% dplyr::filter(Var1 != "0") %>% dplyr::pull(Freq) %>% sum()` cases had at lease one red flag assigned to them as a result of data integrity checks. 

```{r echo=FALSE}
preprocessing_log_ls$flags_freq_df %>% dplyr::rename(`Number of Red Flags` = Var1,
                                                     Frequency = Freq) %>%
  kableExtra::kbl(booktabs = T, longtable = T, caption = "Frequency of red flags from data integrity checks") 
```

```{r echo=FALSE}
flags_tb <- preprocessing_log_ls$flags_smry_tb %>% t() %>% as.data.frame() %>% tibble::rownames_to_column("Outcome") %>% 
  dplyr::rename(N= V1)
```


Of the `r flags_tb %>% dplyr::filter(Outcome == "red_flag_count_int") %>% dplyr::pull(N)` red flags assigned to these cases, `r flags_tb %>% dplyr::filter(Outcome == "red_flag_qltv_ax_lgl") %>% dplyr::pull(N)` were added from the qualitative assessment of participant free text responses, with the balance being flags generated by automated checks of country of origin, inconsistencies between age and date of birth data, email addresses with five or greater consecutive numeric digits, duplicate free text entries across cases and survey completion times of under five minutes.

```{r echo=FALSE}
flags_tb <- preprocessing_log_ls$flags_smry_tb %>% t() %>% as.data.frame() %>% tibble::rownames_to_column("Outcome") %>% 
  dplyr::rename(N=V1)
flags_tb %>% dplyr::filter(startsWith(Outcome, "red_flag")) %>%
  kableExtra::kbl(booktabs = T, longtable = T, caption = "Types of red flags") 
```
In `r flags_tb %>% dplyr::filter(Outcome =="exluded_by_alg_lgl")  %>% dplyr::pull(N)` cases the red flags generated by automated assessments were not in conflict with qualitative assessment (ie the qualitative assessment either also assigned a red flag or did not assign a green flag). These confirmed red flagged records were excluded along with an additional `r flags_tb %>% dplyr::filter(Outcome =="qltv_force_out_lgl")  %>% dplyr::pull(N)` records that were red flagged by the qualitative assessment but which had no automatically generated red flags. In `r flags_tb %>% dplyr::filter(Outcome =="qltv_force_in_lgl")  %>% dplyr::pull(N)` cases, red-flags added by the automated assessment were in conflict with green flags added by the qualitative assessment - these records were retained. In total, the qualitative assessment assigned a total of `r flags_tb %>% dplyr::filter(Outcome =="green_flag_qltv_ax_lgl")  %>% dplyr::pull(N)` green flags to confirm records for inclusion.

```{r echo=FALSE}
flags_tb %>% dplyr::filter(!startsWith(Outcome, "red_flag")) %>%
  kableExtra::kbl(booktabs = T, longtable = T, caption = "Qualitative and automated assessment summary") 
```

After dropping records arising from the data integrity checks, `r preprocessing_log_ls$raw_unflagged_1L_int` records remained.

```{r include=FALSE}
preprocessing_log_ls$raw_unflagged_1L_int
```


When these records were combined with the choice cards dataset and that merged dataset reshaped to long format (each case being a unique combination of the `r dce_design_ls$choice_sets_ls$alternatives_chr %>% length()` alternatives for each of `r dce_design_ls$choice_sets_ls$nbr_of_sets_1L_int/dce_design_ls$choice_sets_ls$nbr_of_blocks_1L_int` choice situations presented to each individual participant) the number of records expanded to `r preprocessing_log_ls$cases_wide_1L_int`.

```{r include=FALSE}
preprocessing_log_ls$cases_wide_1L_int
```

\newpage

# Descriptives

## Participant characteristics
```{r echo= F, results='asis'}
descriptives_ls$summary_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, caption = "Participant Characteristics") %>%
  kableExtra::collapse_rows(columns = 1)
```

\newpage

## Representativeness of sample

```{r echo=FALSE}
descriptives_ls$prpn_cmprsns_ls$age_cmprsn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Sample age proportions compared to official population estimates") 
```
```{r echo=F}
descriptives_ls$prpn_cmprsns_ls$area_cmprsn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Sample resident jurisdictions proportions compared to age and sex based official population estimates") 
```
```{r echo = F}
descriptives_ls$prpn_cmprsns_ls$SEIFA_cmprsn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Sample area disadvantage proportions compared to expected proportions") 
```
```{r echo = F}
descriptives_ls$prpn_cmprsns_ls$urban_cmprsn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Sample urbanicity proportions compared to age and sex based official population estimates") 
```
\newpage
## Choice responses

### Outcomes Attribute
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$Outcomes$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Outcomes attribute choice responses") 
```
```{r fig.cap="Outcomes attribute", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$Outcomes$plot_plt
```

\newpage

### Information sharing Attribute
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$Information_sharing$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Information sharing attribute choice responses") 
```
```{r fig.cap="Information sharing attribute", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$Information_sharing$plot_plt
```

\newpage

### Social Attribute
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$Social$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Social attribute choice responses") 
```
```{r fig.cap="Social attribute", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$Social$plot_plt
```

\newpage

### Endorsers Attribute
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$Endorsers$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Endorsers attribute choice responses") 
```
```{r fig.cap="Endorsers attribute", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$Endorsers$plot_plt
```

\newpage

### Cost Attribute
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$Cost$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Cost attribute choice responses") 
```
```{r fig.cap="Cost attribute", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$Cost$plot_plt
```

\newpage


### Opt out alternative
```{r echo=FALSE}
descriptives_ls$choice_smrys_ls$opt_out$table_tbl %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Opt out alternative responses") 
```
```{r fig.cap="Opt out alternativee", echo=FALSE, message=F, out.width = "400px"}
descriptives_ls$choice_smrys_ls$opt_out$plot_plt
```

\newpage

# Models
```{r echo=F}
make_mdl_smry <- function(model_mdl,
                          return_1L_chr = "coefficients"){
  smry_ls <- summary(model_mdl) 
  if("gmnl" %in% class(model_mdl)#startsWith(deparse(smry_ls$call)[1],"gmnl")
     ){
    smry_ls <- gmnl::getSummary.gmnl(model_mdl)
    coef_mat <- smry_ls$coef
      perf_tb <- smry_ls$sumstat %>% purrr::discard(is.na) %>% as.data.frame() %>% tibble::rownames_to_column("Statistic") %>%
      tibble::as_tibble() %>% dplyr::rename(Value = ".") 
    p_var_nm_1L_chr <- "p"
  }else{
  coef_mat <- smry_ls$CoefTable
  perf_tb <- tibble::tibble(Statistic = c("logLik","AIC", "BIC","N"),
                            Value = c(smry_ls$logLik,AIC(model_mdl),BIC(model_mdl),smry_ls$freq %>% sum()))
  p_var_nm_1L_chr <-"Pr(>|z|)"
  }
  call_1L_chr <- smry_ls$call %>% deparse() %>% paste0(collapse = "") %>% stringr::str_squish()
  coef_tb <- coef_mat %>%  as.data.frame() %>% tibble::rownames_to_column("Parameter") %>% 
      tibble::as_tibble() %>% dplyr::mutate(sign = cut(!!rlang::sym(p_var_nm_1L_chr), breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1,Inf), 
                                                       labels = c("***", "**", "*", ".","n.s."), right = FALSE)) 
  if(return_1L_chr == "coefficients")
    return_xx <- coef_tb 
  if(return_1L_chr == "performance")
    return_xx <- perf_tb %>%
    dplyr::filter(!is.na(Value))
  if(return_1L_chr == "call")
    return_xx <- call_1L_chr
  return(return_xx)
}
```

## Models of how social anxiety app attributes shape the choice behaviour of young people

```{r echo=FALSE}
make_mdl_smry(mdls_ls$mnl_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Multinomial Logit Model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mnl_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Performance of Multinomial Logit Model (estimated with gmnl package)")
```

\newpage

```{r echo=FALSE}
make_mdl_smry(mdls_ls$mnl_mlogit_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Multinomial Logit Model (estimated with mlogit package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mnl_mlogit_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Performance of Multinomial Logit Model (estimated with mlogit package)")
```

\newpage

## Models of the heterogeneity of young people's preferences for social anxiety apps

```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Performance of Mixed Logit Model (estimated with gmnl package)")
```

\newpage

```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mlogit_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model (estimated with mlogit package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mlogit_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Performance of Mixed Logit Model (estimated with mlogit package)")
```

\newpage

```{r echo=FALSE}
make_mdl_smry(mdls_ls$gmnl_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Generalised Multinomial Logit Model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$gmnl_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Performance of Generalised Multinomial Logit Model (estimated with gmnl package)")
```

\newpage

## Models of the the relationship between young people's characteristics and their preferences for social anxiety apps

```{r echo=FALSE}
mdls_ls$att_predn_mdls_ls %>% make_signft_concepts_tbl(mdl_params_ls) %>% 
  dplyr::select(-c(predicts_ls,predictors_ls, total_int)) %>%
  t() %>%
  as.data.frame() %>%
  tibble::rownames_to_column() %>%
  janitor::row_to_names(1) %>%
  tibble::as_tibble()  %>%
  dplyr::rename(Attribute = concept_chr) %>%
  dplyr::mutate(Attribute = Attribute %>% stringr::str_remove_all("_predrs_chr"),
                jurisdiction = jurisdiction %>% stringr::str_remove_all("der_STE_"),
                `area disadvantage` = `area disadvantage` %>% stringr::str_remove_all("der_SEIFA_")) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Signficiant pareticipant characteristic predictors of each attribute from attribute specific mixed models (all estimated with gmnl package)")
```


```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$jurisdiction_gender_urbanicity) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, jurisdiction and urbanicity characteristics (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$`area disadvantage_gender_urbanicity`, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, jurisdiction and urbanicity characteristics (estimated with gmnl package)")
```

\newpage


```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$`jurisdiction_area disadvantage_gender`) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, jurisdiction and area disadvantage characteristics (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$`jurisdiction_area disadvantage_gender`, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, jurisdiction and area disadvantage characteristics (estimated with gmnl package)")
```

\newpage


```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$`area disadvantage_gender_urbanicity`) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, area disadvantage and urbanicity characteristics (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mixl_mdl_ls$`area disadvantage_gender_urbanicity`, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed Logit Model with gender, area disadvantage and urbanicity characteristics (estimated with gmnl package)")
```

\newpage

## Models of social anxiety app preference based sub-groups of young people

```{r echo=FALSE}
make_mdl_smry(mdls_ls$lc_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Basic latent class model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$lc_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Basic latent class model (estimated with gmnl package)")
```

\newpage

```{r echo=FALSE, fig.cap="Cofficient variation by class in basic latent class model", message=F, out.width = "400px"}
#A visual representation of how coefficients vary by class:
plot_ci_lc(mdls_ls$lc_mdl, var = names(mdl_params_ls$random_params_chr))
```
\newpage


```{r echo=FALSE}
make_mdl_smry(mdls_ls$lc_mxd_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed latent class model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$lc_mxd_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed latent class model (estimated with gmnl package)")
```

\newpage

```{r echo=FALSE}
make_mdl_smry(mdls_ls$mm_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed mixed with uncorrelated random parameters (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE}
make_mdl_smry(mdls_ls$mm_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed mixed with uncorrelated random parameters (estimated with gmnl package)")
```

\newpage

```{r echo=FALSE, warning=FALSE, message=FALSE}
make_mdl_smry(mdls_ls$mm_cor_mdl) %>%
  dplyr::mutate(Parameter = Parameter %>% purrr::map_chr(~stringr::str_replace_all(.x,"Outcomes","Outc") %>%
                                                           stringr::str_replace_all("Information_sharing","Info_sh") %>%
                                                           stringr::str_replace_all("Social","Soc") %>%
                                                           stringr::str_replace_all("Endorsers","End"))) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed mixed with correlated random parameters (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```
```{r echo=FALSE, warning=FALSE, message=FALSE}
make_mdl_smry(mdls_ls$mm_cor_mdl, return_1L_chr = "performance") %>% 
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Mixed mixed with correlated random parameters (estimated with gmnl package)")
```


```{r echo=FALSE, eval=FALSE}
# The yet to be addressed issue with the NAs can also be seen when looking at the standard deviations of the random parameters.
vcov(mdls_ls$mm_cor_mdl,what = "ranp", Q=1, type = "sd", se = T)
vcov(mdls_ls$mm_cor_mdl,what = "ranp", Q=2, type = "sd", se = T)
## Note: unable to assign vcov output to object
```
\newpage

# Applying choice models

## Generating Willingness To Pay Estimates

### Willingness To Pay Estimates from Utility Space
We can use the output of the Multinomial Logit Model we estimated to calculate Willingness To Pay values from utility space.

```{r echo=FALSE}
analysis_ls$wtp_utl_sp_mat %>%  as.data.frame() %>% tibble::rownames_to_column("Parameter") %>% 
      tibble::as_tibble() %>% dplyr::mutate(sign = cut(!!rlang::sym("Pr(>|t|)"), breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1,Inf), 
                                                       labels = c("***", "**", "*", ".","n.s."), right = FALSE))  %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Willingness to pay estimated from utility space using multinomial logit model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```

\newpage

### Willingness To Pay Estimates from WTP Space
Alternatively we can use the Scaled Multinomial Logit Model to calculate Willingness to Pay Values from Willingness To Pay space.
```{r echo= F}
analysis_ls$wtp_smnl_smry_ls$CoefTable %>%  as.data.frame() %>% tibble::rownames_to_column("Parameter") %>% 
      tibble::as_tibble() %>% dplyr::mutate(sign = cut(!!rlang::sym("Pr(>|z|)"), breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1,Inf), 
                                                       labels = c("***", "**", "*", ".","n.s."), right = FALSE))  %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Willingness to pay estimated from willingness to pay space using a scaled multinomial logit model (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```

\newpage

### Willingness To Pay Heterogeneity
We can also explore how WTP values vary across individuals.
```{r}

```

```{r echo=FALSE}
#analysis_ls$wtp_gmnl_smry_ls
make_mdl_smry(mdls_ls$gmnl_wtp_mdl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Willingness to pay estimated from generalised multinomial logit model with uncorrelated random parameters (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```

```{r echo=FALSE}
#aanalysis_ls$wtp_gmnl_cor_smry_ls 
make_mdl_smry(mdls_ls$gmnl_wtp_cor_mdl) %>%
  dplyr::mutate(Parameter = Parameter %>% purrr::map_chr(~stringr::str_replace_all(.x,"Outcomes","Outc") %>%
                                                           stringr::str_replace_all("Information_sharing","Info_sh") %>%
                                                           stringr::str_replace_all("Social","Soc") %>%
                                                           stringr::str_replace_all("Endorsers","End"))) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Willingness to pay estimated from generalised multinomial logit model with correlated random parameters (estimated with gmnl package)") %>%
    kableExtra::footnote(general = "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")
```


## Predicting Market Share

### Market share predictions using the same choice situations as that used in the original survey

```{r echo=FALSE}
tibble::tibble(Alternative = names(analysis_ls$prpns_mnl_prdn_dbl),
               `Predictions (MNL model, gmnl package)` = analysis_ls$prpns_mnl_prdn_dbl,
               `Predictions (MNL model, mlogit package)` = analysis_ls$prpns_mnl_mlogit_prdn_dbl,
               Observed = analysis_ls$prpns_obsd_dbl) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from multinomial logit models compared to observed sample proportions") 
```

```{r echo=FALSE}
analysis_ls$prpns_mixl_prdn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from mixed logit models (estimated with gmnl package)") 
```
```{r echo=FALSE}
analysis_ls$prpns_mixl_mlogit_prdn_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from mixed logit models (estimated with mlogit package)") 
```

### Market share predictions using new choice situations
We created a hypothetical choice situation where:
 - the Entourage app had a $25 cost, was endorsed by experts, had both peer and clinician moderators, provided knowledge and skills to manage future situations and shared no information with app users' treating clinicians; and
 - a competing app had a $0 cost, had no endorsers, had no discussions with other app users, provided knowledge and skills to manage future situations and shared no information with app users' treating clinicians.

The market share predictions from both a multinomial model and mixed logit model for each app under this choice situation is summarised in the following table.

```{r echo=FALSE}
analysis_ls$new_data_ls$comparison_1_ls$predd_share_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from multinomial and mixed logit models (both estimated with mlogit package) of hypotetical choice situation one") 
```

We then changed the configuration of the Entourage app by adding a user controlled setting for app information sharing. The market share predictions under this modified scenario are summarised in the next table.

```{r echo=FALSE}
analysis_ls$new_data_ls$comparison_2_ls$predd_share_tb %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from multinomial and mixed logit models (both estimated with mlogit package) of hypotetical choice situation two") 
```

We reran the first hypothetical choice situation adjusting the price between \$25 and \$50.

```{r echo=FALSE}
analysis_ls$new_data_ls$cost_comparison_ls$predd_shares_ls$mnl_mlogit_mdl_predd_tb %>% dplyr::filter(Cost %in% seq(0,50,by=5)) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from multimomial logit models (estimated with mlogit package) of hypotetical choice situation three") 
```
```{r echo=FALSE}
analysis_ls$new_data_ls$cost_comparison_ls$predd_shares_ls$mixl_mlogit_mdl_predd_tb %>% dplyr::filter(Cost %in% seq(0,50,by=5)) %>%
  kableExtra::kbl(booktabs = T, longtable = T, 
                  caption = "Market share predictions from mixed logit models (estimated with mlogit package) of hypotetical choice situation three") 
```

\elandscape
<!---BLOCK_LANDSCAPE_STOP--->