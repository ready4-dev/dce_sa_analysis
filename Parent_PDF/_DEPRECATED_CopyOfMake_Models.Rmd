---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      -  "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
subtitle: Pre-process data (reproduction)
params:
  eval_1L_lgl: True
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

```{r child="../Child_RMDs/Copyright.Rmd", eval=TRUE}
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code

## Motivation
This program was used to analyse pre-processed survey response data for a Discrete Choice Experiment study that is currently being written up. Future versions of this program will include details of the parent study.

This program us used to estimate models that explore how choice attributes affect the responses of our sample, the heterogeneity of these impacts within our sample, how individual respondent characteristics interacted with choice attributes and whether we can identify distinct sub-groups based on preference profile. Our choice of model depends on which of these objectives we wish to focus on.

## Status
This code is the same version as was used to analyse study data. The only items that have been modified are those that remove references to the local directory structure on which study data was stored.

## Use
When using this code it is important to note that some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, **this code should be run step by step** (i.e run one chunk at a time and do not try to run the program by knitting the R Markdown version of this code). Although it would be possible to add work-arounds to the interactivity issue, running the program by knitting the RMD version is still not recommended as it will prevent the documents generated by this program from rendering properly. 

# Prepare workspace

## Specify data directories

We begin by specifying where our input data can be located and where we wish to write our outputs to. You must supply these details or the rest of this code will not work. 

```{r}
input_data_dir_1L_chr <- "PROVIDE DETAILS HERE"
output_data_dir_1L_chr <- "PROVIDE DETAILS HERE"
```

```{r echo=FALSE, eval=!is.null(params$X)}
input_data_dir_1L_chr <- params$X$input_data_dir_1L_chr
output_data_dir_1L_chr <- params$X$output_data_dir_1L_chr
```

## Reproducibility

We now set a seed to aid reproducibility.

```{r}
set.seed(1001)
```

Having set the seed, it is now likely that if you run the syntax described in this document on your own installation of R you will get identical results to those reported in this document. However, if you do not, it may be that you have a different version of R, or of some of the packages that we used to produce this analysis. We therefore save a record of the software that we have on the machine used for this analysis so this can be made available for comparisons.

```{r}
session_ls <- sessionInfo()
saveRDS(session_ls,
        file = paste0(output_data_dir_1L_chr,
                               "/session_ls.RDS"))
```


## Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# utils::install.packages("magrittr")
```

Next we load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(magrittr)

```
```{r echo=FALSE}
# devtools::install_github("ready4-dev/ready4")
# devtools::install_github("ready4-dev/ready4use")
# library(ready4)
# library(ready4use)
```


# Custom functions
We are also going to use the following third party functions.
```{r}
# From: https://msarrias.weebly.com/uploads/3/7/7/8/37783629/lc_helpers.r
###########################################################
# A series of functions (helpers) for LC-MNL using gmnl.
# By: Mauricio Sarrias
###########################################################

shares <- function(obj){
  if (!inherits(obj, "gmnl")) stop("The model was not estimated using gmnl")
  if (obj$model != "lc") stop("The model is not a LC-MNL")
  bhat <- coef(obj)
  cons_class <- c(0, bhat[grep("(class)", names(bhat), fixed = TRUE)])
  Q <- length(cons_class)
  shares <- exp(cons_class) / sum(exp(cons_class))
  names(shares) <- paste("share q", 1:Q, sep = "=")  
  return(shares)
}


plot_ci_lc <- function(obj, var = NULL, mar = c(2, 5, 2, 2),
                       cex.pts = 0.9, cex.var = 0.8, 
                       var.las = 2, pch.pts = 20, col.pts = 1, ...){
  if (!inherits(obj, "gmnl")) stop("The model was not estimated using gmnl")
  if (obj$model != "lc") stop("The model is not a LC-MNL")
  bhat <- coef(obj)
  se   <- sqrt(diag(vcov(obj)))
  cons_class <- c(0, bhat[grep("(class)", names(bhat), fixed = TRUE)])
  name.x <- if (is.null(var)) names(obj$mf)[-1] else var
  Q <- length(cons_class)
  lc.names <- c()
  for (i in 1:length(name.x)) {
    lc.names <- c(lc.names, paste("class", 1:Q, name.x[i], 
                                  sep = "."))
  }
  bhat <- bhat[lc.names]
  se   <- se[lc.names]
  
  u <-  bhat + 1.96 * se
  l <-  bhat - 1.96 * se
  n.c <- length(bhat)
  idx <- seq(1, n.c)
  k <- 1 / n.c
  
  par(mar = mar)
  plot(c(l, u), c(idx + k, idx - k), 
       type = "n", axes = F, main = "" , xlab = "", 
       ylab = "", ...)
  axis(3)
  axis(2, n.c:1, names(bhat)[n.c:1], las = var.las, 
       tck = FALSE, lty = 0, cex.axis = cex.var)
  abline(v = 0, lty = 2)
  points(bhat, idx, pch = pch.pts, cex = cex.pts, 
         col = col.pts)
  segments(l, idx, u, idx, lwd = 2, 
           col = "red")
}
```

<!-- Custom functions? -->


## Ingest pre-processed data
We now ingest the dataset that we will be analysing. There are two versions of the dataset because some models require the cost attribute to be first multiplied by -1.

```{r}
AT <- readRDS(paste0(output_data_dir_1L_chr,"/AT.RDS"))
AT_1 <- readRDS(paste0(output_data_dir_1L_chr,"/AT_1.RDS"))
```


# Estimate models

## Conditional or Multinomial Logit Model
In the first set of models we estimate, we are only interested in exploring the role of the attributes of the choices and ignore the role of respondent heterogeneity.

We first define the formulation of the model we wish to estimate (a basic multinomial logit model). 

```{r}
f_1 <- mlogit::mFormula(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                          Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                          Endorsers_non_expert + Endorsers_expert + Cost  | -1)

```



```{r echo=FALSE, eval=FALSE}
#The model matrix to estimate this model is:
head(model.matrix(f_1,AT))
```

We can estimate this model with either the mlogit or gmnl packages, the coefficients produced by the output are identical.

```{r}
mnl_1 <- mlogit::mlogit(f_1,AT)
cl_1 <- gmnl::gmnl(f_1,
                     data = AT)

```

We save this output.

```{r}
saveRDS(mnl_1,paste0(output_data_dir_1L_chr,"/mnl_1.RDS"))
saveRDS(cl_1,paste0(output_data_dir_1L_chr,"/cl_1.RDS"))
```


```{r echo=FALSE, eval=FALSE}
summary(mnl_1)
summary(cl_1)
```

## Mixed Logit Models
The next set of models to estimate are those that include random parameters to explore how preferences vary due to respondent heterogeneity. 

### Distribution of random parameters
As an initial step, we specify our expected distribution for each of the choice attribute features. We create two very similar objects that contain this information - the difference in ordering is relevant for a future function call.

```{r}
rpar = c(Cost = 'n',
         Outcomes_curr_symTRUE = 'n',
         Outcomes_curr_sym_future_sitTRUE = 'n',
         Information_sharing_app_policyTRUE  = 'n',
         Information_sharing_user_settingsTRUE = 'n',
         Social_unmod_discTRUE = 'n',
         Social_trained_peer_modTRUE = 'n',
         Social_clinician_modTRUE = 'n',
         Social_peer_clinician_modTRUE = 'n',
         Endorsers_non_expertTRUE = 'n',
         Endorsers_expertTRUE = 'n',
         opt_outTRUE = 'n')
rpar_2_ls = c(Outcomes_curr_symTRUE = 'n',
         Outcomes_curr_sym_future_sitTRUE = 'n',
         Information_sharing_app_policyTRUE  = 'n',
         Information_sharing_user_settingsTRUE = 'n',
         Social_unmod_discTRUE = 'n',
         Social_trained_peer_modTRUE = 'n',
         Social_clinician_modTRUE = 'n',
         Social_peer_clinician_modTRUE = 'n',
         Endorsers_non_expertTRUE = 'n',
         Endorsers_expertTRUE = 'n',
         opt_outTRUE = 'n')
```

### Mixed logit model
Next we estimate a mixed logit model that includes the random parameters as an argument. We do this using both the mlogit and gmnl packages. At this stage we are looking at overall heterogeneity for each parameter and are not exploring the role of specific individual characteristics .

```{r}
mxl_1 <- mlogit::mlogit(f_1, data = AT, rpar = rpar, R = 100, halton = NA, panel = TRUE)
mixl_1 <- gmnl::gmnl(f_1, data = AT, model = "mixl", ranp = rpar, R = 50, panel = T)
```

### Generalized Multinomial Logit Models
We next estimate a Generalized Multinomial Logit Model.

```{r}
gmnl_1 <- gmnl::gmnl(f_1,
                     data = AT,
                     model = "gmnl",
                     ranp = rpar,
                     R = 50,
                     panel = T)

```


### Mixed Logit Models With Individual Specific Variables
#### Objective
We next want to investigate the role of individual respondent characteristics on the coefficients for choice attributes.

#### Interactions with specific choice features
Our first step is to explore which characteristics are influential for each choice feature. We do this by sequentially estimating models that interact all respondent characteristics with a specified choice feature.

```{r}
mixl_hier_1 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(opt_outTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_2 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Cost = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_3 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Outcomes_curr_symTRUE  = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_4 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Outcomes_curr_sym_future_sitTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_5 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Information_sharing_app_policyTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_6 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Information_sharing_user_settingsTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_7 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Social_unmod_discTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_8 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Social_trained_peer_modTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_9 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Social_clinician_modTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_10 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Social_peer_clinician_modTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_11 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(Endorsers_non_expertTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                          R = 50,
                          panel = T)

mixl_hier_12 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                             Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                             Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                           data = AT,
                           model = "mixl",
                           ranp = rpar,
                           mvar = list(Endorsers_expertTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE" , "der_gender_opntsTRUE" , "rc_pilot_participantTRUE" , "der_SIAS_nrTRUE" , "der_SIAS_saTRUE" , "der_under_ten_minsTRUE")),
                           R = 50,
                           panel = T)

```


#### Individual characteristics interacted with all choice features
We then include the significant predictors for each choice feature in a model that includes all choice features.

```{r}
mixl_hier_13 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                            Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                            Endorsers_non_expert + Endorsers_expert +  Cost  | -1 | 0 | der_age_u21 + der_gender_male + der_gender_opnts + rc_pilot_participant + der_SIAS_nr + der_SIAS_sa + der_under_ten_mins - 1,
                          data = AT,
                          model = "mixl",
                          ranp = rpar,
                          mvar = list(opt_outTRUE = c("der_gender_maleTRUE","rc_pilot_participantTRUE" , "der_SIAS_nrTRUE"),
                                      Outcomes_curr_symTRUE  = c("der_gender_opntsTRUE" , "rc_pilot_participantTRUE"),
                                      Outcomes_curr_sym_future_sitTRUE = c("der_age_u21TRUE" , "rc_pilot_participantTRUE"),
                                      Information_sharing_user_settingsTRUE = c("der_gender_opntsTRUE"),
                                      Social_unmod_discTRUE = c("der_SIAS_saTRUE"),
                                      Social_peer_clinician_modTRUE = c("der_age_u21TRUE" , "der_gender_opntsTRUE" , "der_under_ten_minsTRUE"),
                                      Endorsers_non_expertTRUE = c("rc_pilot_participantTRUE"),
                                      Endorsers_expertTRUE = c("der_age_u21TRUE" , "der_gender_maleTRUE"),
                                      Cost = c("rc_pilot_participantTRUE","der_under_ten_minsTRUE")), #Omitted: Information_sharing_app_policyTRUE, Social_trained_peer_modTRUE,Social_clinician_modTRUE
                          R = 50,
                          panel = T)

```


## 3.4 Latent Class Models

### Objective
We are also interested if it is possible to identify subgroups that are distinguishable based on the nature of their preferences. To do this we esimate Latent Class models. 

### Basic Latent Class Models
The first model we estimate seeks to identify two different preference based classes. The second adds respondent characteristic predictors, to identify what characteristics predict membership of which class. For the moment only continuous individual characteristics have been included.

```{r}
lc_1 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                     Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                     Endorsers_non_expert + Endorsers_expert +  Cost  | 0 | 0 | 0 | 1,
                   data = AT,
                   model = "lc",
                   panel = T,
                   Q = 2)
lc_3 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings +
                     Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod +
                     Endorsers_non_expert + Endorsers_expert +  Cost  | 0 | 0 | 0 | rc_age + der_SIAS_TOT + rc_time_taken_secs,
                   data = AT,
                   model = "lc",
                   panel = T,
                   Q = 2)

```



```{r eval=FALSE, echo=FALSE}
#A visual representation of how coefficients vary by class:
# source("DOWNLOADED_lc_helpers.r")
plot_ci_lc(lc_1, var = names(rpar))
#plot_ci_lc(lc_3, var = names(rpar))
```

### Mixed-Mixed Multinomial Logit Model
The next group of models to be estimate add random parameters to the latent classes. The main difference between the two models estimated at this step are the addition of an argument to explore correlations in the random parameters.

<!-- Note: As is clear from the output below, the second model specification produced NA values. This issue will be addressed in a future version of this report.  -->

```{r}
mm_1 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                     Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                     Endorsers_non_expert + Endorsers_expert +  Cost  | 0 | 0 | 0 | 1,
                   data = AT,
                   model = "mm",
                   R=50,
                   panel = T,
                   ranp = rpar,
                   Q = 2,
                   iterlim = 500)
mm_c_1 <- gmnl::gmnl(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
                     Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
                     Endorsers_non_expert + Endorsers_expert +  Cost  | 0 | 0 | 0 | 1,
                   data = AT,
                   model = "mm",
                   R=50,
                   panel = T,
                   ranp = rpar,
                   Q = 2,
                   iterlim = 500,
                   correlation = T)

```



```{r echo=FALSE, eval=TRUE}
# The yet to be addressed issue with the NAs can also be seen when looking at the standard deviations of the random parameters.
vcov(mm_c_1,what = "ranp", Q=1, type = "sd", se = T)
vcov(mm_c_1,what = "ranp", Q=2, type = "sd", se = T)
## Note: unable to assign vcov output to object
```

# 4. Calculating Willingness To Pay

## 4.1 Goal
Our next step is to calculate Willingness To Pay values for the different attributes of social anxiety apps. We can do this either from utililty space (using ratios of the coefficients from the models that we have previously calculated) or from willingness to pay space (esimtating some new models).

## 4.2 Willingness To Pay Estimates from Utility Space
The first step is to use the output of the first and simplest model that we estimated.

```{r, include=F }
wtp_cl_1 <- gmnl::wtp.gmnl(cl_1,wrt = "Cost")
```
```{r}
wtp_cl_1[,1] = wtp_cl_1[,1]*-1
wtp_cl_1
```

## 4.3 Willingness To Pay Estimates from WTP Space
### 4.3.1 Scaled Multinomial Logit Model
The first step of the process to esimtate this model is to specify the formula for the model and starting and fixed values vectors. [EXPLAIN]

```{r}
##
start_vec <- c(0,0,0,0,0,0,0,0,0,0,0,1,0,0)
fixed_vec <- c(F,F,F,F,F,F,F,F,F,F,F,T,T,F)
##
f_2 <- mlogit::mFormula(choice ~ opt_out + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
  Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
  Endorsers_non_expert + Endorsers_expert +  Cost  | 0 | 0 | 0 | 1)
# f_2_x <- mlogit::mFormula(choice ~ Cost + Outcomes_curr_sym + Outcomes_curr_sym_future_sit + Information_sharing_app_policy  + Information_sharing_user_settings + 
#                           Social_unmod_disc + Social_trained_peer_mod + Social_clinician_mod + Social_peer_clinician_mod + 
#                           Endorsers_non_expert + Endorsers_expert + opt_out | 0 | 0 | 0 | 1)
```

The next step is to estimate the model.

```{r}
wtp_smnl <- gmnl::gmnl(f_2, data = AT_1, model = "smnl", R = 1, fixed = fixed_vec, panel = T, start = start_vec, method = "bhhh", iterlim = 500)
```

```{r}
summary(wtp_smnl)
```








\elandscape
<!---BLOCK_LANDSCAPE_STOP--->

